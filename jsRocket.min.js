/*! jsRocket - v0.0.1 - 2013-03-02
* https://github.com/mog/jsRocket
* Copyright (c) 2013 mog; Licensed MIT*/

var JSRocket={};JSRocket.SyncData=function(){"use strict";function t(t){return e[t]}function n(t){for(var n=0;n<e.length;n++)if(e[n].name===t)return n;return-1}function r(){return e.length}function i(t){var n=new JSRocket.Track;n.name=t,e.push(n)}var e=[];return{getTrack:t,getIndexForName:n,getTrackLength:r,createIndex:i}},JSRocket.Track=function(){"use strict";function o(s){var o=Math.floor(s),a=u(o),f=a.low,l=a.high,c;if(isNaN(f))return NaN;if(isNaN(l)||i[f].interpolation===e)return i[f].value;switch(i[f].interpolation){case t:return c=(s-f)/(l-f),i[f].value+(i[l].value-i[f].value)*c;case n:return c=(s-f)/(l-f),c=c*c*(3-2*c),i[l].value*c+i[f].value*(1-c);case r:return c=Math.pow((s-f)/(l-f),2),i[f].value+(i[l].value-i[f].value)*c}return NaN}function u(e){var t=NaN,n=NaN;for(var r=0;r<s.length;r++)if(s[r]<=e)t=s[r];else if(s[r]>=e){n=s[r];break}return{low:t,high:n}}function a(e,t,n,r){l(e),s.push(e),i[e]={value:t,interpolation:n},r!==!0&&f()}function f(){s=s.sort(function(e,t){return e-t})}function l(e){s.indexOf(e)>-1&&(s.splice(s.indexOf(e),1),delete i[e])}var e=0,t=1,n=2,r=3,i=[],s=[];return{getValue:o,sortIndex:f,add:a,remove:l}},JSRocket.SyncDevicePlayer=function(e){"use strict";function i(e){t=new XMLHttpRequest;if(t===null){r.error();return}t.open("GET",e,!0),t.onreadystatechange=s,t.send()}function s(){t.readyState===4&&(t.status<300?o(t.responseText):r.error())}function o(e){var t,n=0,i,s=0,o,a=(new DOMParser).parseFromString(e,"text/xml"),f=a.getElementsByTagName("tracks"),l=f[0].getElementsByTagName("track");for(n,i=l.length;n<i;n++){var c=u(l[n].getAttribute("name")),h=l[n].getElementsByTagName("key");for(s=0,o=h.length;s<o;s++)t=h[s],c.add(parseInt(t.getAttribute("row"),10),parseFloat(t.getAttribute("value")),parseInt(t.getAttribute("interpolation"),10),!0);c.sortIndex()}r.ready()}function u(e){var t=n.getIndexForName(e);return t>-1?n.getTrack(t):(n.createIndex(e),n.getTrack(n.getTrackLength()-1))}function a(e,t){r[e]=t}function f(){}var t,n=new JSRocket.SyncData,r={ready:function(){},error:function(){}};if(e.rocketXML===""||e.rocketXML===undefined||e.rocketXML===undefined)throw"[jsRocket] rocketXML is not set, try _syncDevice.setConfig({'rocketXML':'url/To/RocketXML.rocket'})";return i(e.rocketXML),{load:i,getTrack:u,update:f,on:a}},JSRocket.SyncDeviceClient=function(e){"use strict";function l(){u.binaryType="arraybuffer",u.send("hello, synctracker!")}function c(e){var r=new Uint8Array(e.data),u=r[0],l,c,h,p;u===104?f.ready():s===u?r[1]===1?f.pause():f.play():i===u?(c=m(r.subarray(1,5)),f.update(c)):t===u?(l=m(r.subarray(1,5)),c=m(r.subarray(5,9)),h=g(r.subarray(9,13)),p=m(r.subarray(13,14)),a.getTrack(l).add(c,h,p),f.update()):n===u?(l=m(r.subarray(1,5)),c=m(r.subarray(5,9)),a.getTrack(l).remove(c),f.update()):o===u&&f.save()}function h(e){console.warn(">> connection closed",e)}function p(e){console.error(">> connection error'd",e)}function d(e){var t=a.getIndexForName(e);return t>-1?a.getTrack(t):(u.send((new Uint8Array([r,0,0,0,e.length])).buffer),u.send(e),a.createIndex(e),a.getTrack(a.getTrackLength()-1))}function v(e){var t=[e>>24&255,e>>16&255,e>>8&255,e&255];u.send((new Uint8Array([i,t[0],t[1],t[2],t[3]])).buffer)}function m(e){var t=0,n=new DataView(new ArrayBuffer(e.length));for(;t<e.length;t++)n.setUint8(t,e[t]);return n.byteLength===1?n.getInt8(0):n.getInt32(0)}function g(e){var t=new DataView(new ArrayBuffer(4));return t.setUint8(0,e[0]),t.setUint8(1,e[1]),t.setUint8(2,e[2]),t.setUint8(3,e[3]),t.getFloat32(0)}function y(e,t){f[e]=t}var t=0,n=1,r=2,i=3,s=4,o=5,u=new WebSocket(e.socketURL),a=new JSRocket.SyncData,f={ready:function(){},update:function(){},play:function(){},pause:function(){},save:function(){}};return u.onopen=l,u.onmessage=c,u.onclose=h,u.onerror=p,{getTrack:d,update:v,on:y}},JSRocket.SyncDevice=function(){"use strict";function s(e){e==="demo"?t=new JSRocket.SyncDevicePlayer(r):t=new JSRocket.SyncDeviceClient(r),t.on("ready",a),t.on("update",f),t.on("play",l),t.on("pause",c)}function o(){return r}function u(e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}function a(){e=!0,i.ready()}function f(e){i.update(e)}function l(){i.play()}function c(){i.pause()}function h(n){return e?t.getTrack(n):null}function p(e){Math.floor(e)!==n&&(n=Math.floor(e),t.update(n))}function d(e,t){i[e]=t}var e=!1,t,n,r={socketURL:"ws://localhost:1338",rocketXML:""},i={ready:function(){},update:function(){},play:function(){},pause:function(){}};return{init:s,setConfig:u,getConfig:o,getTrack:h,update:p,on:d}};